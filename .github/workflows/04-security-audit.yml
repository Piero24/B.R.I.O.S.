name: 04 ‚Äî Security Audit

################################################################################
# DEPENDENCY VULNERABILITY SCANNING WORKFLOW
#
# Purpose:
#   Automatically scans Python dependencies for known security vulnerabilities
#   using pip-audit. This prevents vulnerable packages from being deployed to
#   production and alerts developers to security issues early in the CI pipeline.
#
# When it runs:
#   ‚Ä¢ On every push to the 'main' branch
#   ‚Ä¢ On every pull request to any branch
#   ‚Ä¢ Can be manually triggered via GitHub UI
#
# What it does:
#   1. Waits for unit tests to pass (dependency)
#   2. Checks out the repository code
#   3. Sets up Python 3.12.6 environment
#   4. Installs all project dependencies
#   5. Installs pip-audit security scanner
#   6. Scans installed packages for CVEs and security advisories
#
# Vulnerability detection:
#   pip-audit checks each installed package against:
#     ‚Ä¢ PyPI Advisory Database
#     ‚Ä¢ OSV (Open Source Vulnerabilities) database
#     ‚Ä¢ Known CVEs (Common Vulnerabilities and Exposures)
#
#   It reports:
#     ‚Ä¢ Package name and version
#     ‚Ä¢ Vulnerability ID (CVE, GHSA, etc.)
#     ‚Ä¢ Severity level (low, medium, high, critical)
#     ‚Ä¢ Fixed version (if available)
#
# Success criteria:
#   No vulnerabilities found in any installed package.
#
# Failure handling:
#   If vulnerabilities are detected:
#     1. Review the vulnerability details in the workflow logs
#     2. Update affected packages to patched versions in requirements/
#     3. If no patch exists, evaluate the risk and document the decision
#     4. Re-run the workflow to verify fixes
#
# Special considerations:
#   ‚Ä¢ Uses requirements/ci.txt (excludes macOS-only packages)
#   ‚Ä¢ May produce false positives; verify all findings
#   ‚Ä¢ Some vulnerabilities may not have patches yet
#   ‚Ä¢ Low-severity issues in dev dependencies may be acceptable
#
# Dependencies:
#   Requires: 02-unit-tests.yml (must pass first)
#   Required by: None (terminal workflow in the pipeline)
#
# Exit codes:
#   0: No vulnerabilities detected
#   1: One or more vulnerabilities found (workflow fails)
################################################################################

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

jobs:
  security-audit:
    name: üîê Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      ########################################################################
      # Step 1: Checkout Repository
      #
      # Fetches requirements/ci.txt and any other files needed to install
      # and scan project dependencies.
      ########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ########################################################################
      # Step 2: Configure Python Environment
      #
      # Installs Python 3.12.6 to match our development environment. This
      # ensures we're auditing the same dependency versions that will be
      # used in production.
      ########################################################################
      - name: Set up Python 3.12.6
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.6'

      ########################################################################
      # Step 3: Install Project Dependencies
      #
      # Installs all packages from requirements-ci.txt before running the
      # audit. pip-audit needs packages to be installed so it can check
      # their versions against vulnerability databases.
      #
      # Uses requirements-ci.txt to match the Linux CI environment and
      # avoid macOS-specific packages.
      ########################################################################
            ########################################################################
      # Step 3: Install Dependencies
      #
      # Installs all packages from requirements/ci.txt before running the
      # security audit. This ensures pip-audit has access to the actual
      # packages to scan for vulnerabilities.
      #
      # Uses requirements/ci.txt to match the Linux CI environment and
      # exclude macOS-specific pyobjc packages.
      ########################################################################
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/ci.txt

      ########################################################################
      # Step 4: Install Security Audit Tool
      #
      # Installs pip-audit, a tool that scans Python packages for known
      # security vulnerabilities by querying CVE and advisory databases.
      ########################################################################
      - name: Install pip-audit
        run: pip install pip-audit

      ########################################################################
      # Step 5: Execute Security Audit
      #
      # Runs pip-audit against all installed packages. The tool will:
      #   1. Enumerate all installed packages
      #   2. Query vulnerability databases for each package/version
      #   3. Report any known security issues
      #
      # Output includes:
      #   ‚Ä¢ Vulnerable package name and version
      #   ‚Ä¢ Vulnerability ID (CVE-XXXX-XXXXX, GHSA-XXXX-XXXX-XXXX)
      #   ‚Ä¢ Description of the vulnerability
      #   ‚Ä¢ Fixed version recommendation
      #
      # The workflow fails if any vulnerabilities are found, blocking merge
      # and deployment until they are addressed.
      ########################################################################
      - name: Scan for vulnerabilities
        run: |
          echo "üîê Scanning dependencies for security vulnerabilities..."
          pip-audit
