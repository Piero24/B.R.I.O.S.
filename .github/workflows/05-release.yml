name: 05 ‚Äî Automatic Release

################################################################################
# AUTOMATIC RELEASE WORKFLOW
#
# Purpose:
#   Automates the creation of a GitHub Release whenever a new version
#   is detected on the main branch. This ensures that a release is
#   created only when the VERSION file is updated.
#
# When it runs:
#   ‚Ä¢ On every push to the 'main' branch
#   ‚Ä¢ Can be manually triggered via GitHub UI (workflow_dispatch)
#
# What it does:
#   1. Checks out the repository
#   2. Reads the version from the 'VERSION' file
#   3. Checks if a tag for this version already exists
#   4. If the tag is NEW: Creates the tag and a new GitHub Release
#   5. If the tag EXISTS: Skips creation to preserve release history
#
# Success criteria:
#   A GitHub Release exists for the current version in the repo.
################################################################################

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
#  # Gate: Ensure all CI checks passed before releasing
#  check-ci:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Wait for CI workflows to complete
#        uses: actions/github-script@v7
#        with:
#          script: |
#            const sha = context.sha;
#            const owner = context.repo.owner;
#            const repo = context.repo.repo;
#
#            const requiredChecks = [
#              '01 ‚Äî Code Formatting Check',
#              '02 ‚Äî Unit Tests',
#              '03 ‚Äî Type Checking',
#              '04 ‚Äî Security Audit',
#            ];
#
#            // Wait up to 3 minutes for all checks to complete
#            const maxWait = 180;
#            const interval = 10;
#            let elapsed = 0;
#
#            while (elapsed < maxWait) {
#              const { data: checkRuns } = await github.rest.checks.listForRef({
#                owner, repo, ref: sha, per_page: 100,
#              });
#
#              const results = requiredChecks.map(name => {
#                const run = checkRuns.check_runs.find(r => r.name === name);
#                return { name, status: run?.status, conclusion: run?.conclusion };
#              });
#
#              const allComplete = results.every(r => r.status === 'completed');
#              const allPassed = results.every(r => r.conclusion === 'success');
#
#              if (allComplete) {
#                if (allPassed) {
#                  console.log('‚úÖ All CI checks passed!');
#                  for (const r of results) {
#                    console.log(`  ‚úì ${r.name}: ${r.conclusion}`);
#                  }
#                  return;
#                } else {
#                  const failed = results.filter(r => r.conclusion !== 'success');
#                  for (const r of failed) {
#                    console.log(`  ‚úó ${r.name}: ${r.conclusion}`);
#                  }
#                  core.setFailed('‚ùå CI checks failed. Release aborted.');
#                  return;
#                }
#              }
#
#              const pending = results.filter(r => r.status !== 'completed');
#              console.log(`‚è≥ Waiting for ${pending.length} check(s)... (${elapsed}s)`);
#              await new Promise(r => setTimeout(r, interval * 1000));
#              elapsed += interval;
#            }
#
#            core.setFailed('‚ùå Timeout: CI checks did not complete within 3 minutes.');

  release:
#    needs: check-ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Extract version and prepare tag
          VERSION=$(cat VERSION)
          TAG="v$VERSION"
          
          echo "üöÄ Checking if $TAG already exists..."
          
          # 2. Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "‚úÖ Tag $TAG already exists. Skipping release creation."
            exit 0
          fi
          
          # 3. Create and push new tag
          echo "üè∑Ô∏è Creating new tag $TAG..."
          git tag "$TAG"
          git push origin "$TAG"
          
          # 4. Create new release
          echo "üö¢ Creating new GitHub release..."
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file CHANGELOG.md

          # 5. Update Homebrew Formula
          echo "üç∫ Updating Homebrew formula..."
          TARBALL_URL="https://github.com/Piero24/B.R.I.O.S./archive/refs/tags/$TAG.tar.gz"
          
          # Wait a few seconds to ensure GitHub has generated the tarball
          sleep 5
          
          curl -sL "$TARBALL_URL" -o temp.tar.gz
          SHA256=$(shasum -a 256 temp.tar.gz | awk '{print $1}')
          rm temp.tar.gz
          
          echo "New SHA256: $SHA256"
          
          python3 -c "
          import re
          with open('Formula/brios.rb', 'r') as f: content = f.read()
          content = re.sub(r'url \"https://github\.com/Piero24/B\.R\.I\.O\.S\./archive/refs/tags/.*\.tar\.gz\"', 'url \"${TARBALL_URL}\"', content, count=1)
          content = re.sub(r'sha256 \"[a-f0-9]{64}\"', 'sha256 \"${SHA256}\"', content, count=1)
          with open('Formula/brios.rb', 'w') as f: f.write(content)
          "
          
          # 6. Update README.md version
          echo "üìù Updating README.md version..."
          python3 -c "
          import re
          with open('.github/README.md', 'r') as f: content = f.read()
          content = re.sub(r'<sub>Version .*?</sub>', f'<sub>Version ${VERSION}</sub>', content, count=1)
          with open('.github/README.md', 'w') as f: f.write(content)
          "
          
          # 7. Commit and push updates
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/brios.rb .github/README.md
          
          if ! git diff --cached --quiet; then
            echo "üì¶ Committing updated formula and README..."
            git commit -m "chore: update Homebrew formula and README to $TAG [skip ci]"
            git push origin main
          else
            echo "‚úÖ Formula and README are already up to date."
          fi
