name: 05 ‚Äî Automatic Release

################################################################################
# AUTOMATIC RELEASE WORKFLOW
#
# Purpose:
#   Automates the creation of a GitHub Release whenever a new version
#   is detected on the main branch. This ensures that a release is
#   created only when the VERSION file is updated.
#
# When it runs:
#   ‚Ä¢ On every push to the 'main' branch
#   ‚Ä¢ Can be manually triggered via GitHub UI (workflow_dispatch)
#
# What it does:
#   1. Checks out the repository
#   2. Reads the version from the 'VERSION' file
#   3. Checks if a tag for this version already exists
#   4. If the tag is NEW:
#      a. Creates the tag and a new GitHub Release
#      b. Produces a stable tarball via `git archive` and attaches it
#         as a release asset (avoids GitHub's auto-generated archive
#         whose checksum can change over time)
#      c. Updates the Homebrew formula with the stable asset URL + SHA256
#      d. Updates the README version badge
#      e. Opens a PR with the post-release chore commit using the PAT
#         so that branch protection is bypassed and the PR auto-merges
#   5. If the tag EXISTS: Skips creation to preserve release history
#
# Branch protection:
#   RELEASE_PAT must belong to a user who is listed as a bypass actor in
#   the branch protection ruleset. The bot opens a PR and auto-merges it
#   using the PAT, which satisfies the PR requirement.
#
# Success criteria:
#   A GitHub Release exists for the current version in the repo.
################################################################################

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    # Skip if this push is the merge of the automated post-release chore PR
    if: >-
      !contains(github.event.head_commit.message,
      'chore: update Homebrew formula and README')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release
        env:
          RELEASE_PAT: ${{ secrets.RELEASE_PAT }}
        run: |
          # Require the PAT to be present
          if [ -z "$RELEASE_PAT" ]; then
            echo "ERROR: RELEASE_PAT secret is not set. Add the PAT as the repository secret 'RELEASE_PAT'."
            exit 1
          fi

          # Validate the PAT quickly against the GitHub API to catch expiration
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $RELEASE_PAT" https://api.github.com/user)
          if [ "$STATUS_CODE" != "200" ]; then
            echo "ERROR: RELEASE_PAT appears invalid or expired (HTTP $STATUS_CODE). Please create a new PAT and update the 'RELEASE_PAT' secret."
            exit 1
          fi

          # Export GH_TOKEN so 'gh' and other tools pick it up
          export GH_TOKEN="$RELEASE_PAT"

          # 1. Extract version and prepare tag
          VERSION=$(cat VERSION)
          TAG="v$VERSION"

          echo "üöÄ Checking if $TAG already exists..."

          # Configure git remote to use the provided PAT for pushes
          git remote set-url origin https://x-access-token:$GH_TOKEN@github.com/$GITHUB_REPOSITORY.git

          # 2. Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "‚úÖ Tag $TAG already exists. Skipping release creation."
            exit 0
          fi

          # 3. Create and push new tag
          echo "üè∑Ô∏è Creating new tag $TAG..."
          git tag "$TAG"
          git push origin "$TAG"

          # 4. Create new release
          echo "üö¢ Creating new GitHub release..."
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file CHANGELOG.md

          # 5. Build a stable tarball and attach it as a release asset
          #    (GitHub's auto-generated /archive/ tarballs can be regenerated
          #    at any time, changing their checksum ‚Äî release assets are stable)
          echo "üì¶ Creating stable source tarball..."
          ASSET_NAME="brios-${VERSION}.tar.gz"
          git archive --format=tar.gz --prefix="B.R.I.O.S.-${VERSION}/" "$TAG" \
            -o "$ASSET_NAME"
          gh release upload "$TAG" "$ASSET_NAME"

          TARBALL_URL="https://github.com/Piero24/B.R.I.O.S./releases/download/$TAG/$ASSET_NAME"
          SHA256=$(shasum -a 256 "$ASSET_NAME" | awk '{print $1}')
          rm "$ASSET_NAME"

          echo "New SHA256: $SHA256"

          # 6. Update Homebrew Formula
          echo "üç∫ Updating Homebrew formula..."
          python3 -c "
          import re
          with open('Formula/brios.rb', 'r') as f: content = f.read()
          content = re.sub(r'url \"https://github\.com/Piero24/B\.R\.I\.O\.S\./.*\.tar\.gz\"', 'url \"${TARBALL_URL}\"', content, count=1)
          content = re.sub(r'sha256 \"[a-f0-9]{64}\"', 'sha256 \"${SHA256}\"', content, count=1)
          with open('Formula/brios.rb', 'w') as f: f.write(content)
          "

          # 7. Update README.md version
          echo "üìù Updating README.md version..."
          python3 -c "
          import re
          with open('.github/README.md', 'r') as f: content = f.read()
          content = re.sub(r'<sub>Version .*?</sub>', f'<sub>Version ${VERSION}</sub>', content, count=1)
          with open('.github/README.md', 'w') as f: f.write(content)
          "

          # 8. Open a PR with the updated formula and README using the PAT
          #    (branch protection requires a PR; the PAT owner must be a bypass
          #    actor so that auto-merge can land without a review)
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/brios.rb .github/README.md

          if ! git diff --cached --quiet; then
            echo "üì¶ Committing updated formula and README..."
            BRANCH="chore/release-$TAG"
            git checkout -b "$BRANCH"
            git commit -m "chore: update Homebrew formula and README to $TAG"
            git push origin "$BRANCH"

            echo "üîÄ Opening PR to merge formula/README update into main..."
            gh pr create \
              --title "chore: update Homebrew formula and README to $TAG" \
              --body "Automated post-release update: Homebrew formula URL + SHA256 and README version badge bumped to $TAG." \
              --base main \
              --head "$BRANCH"

            echo "‚ö° Merging PR using PAT bypass..."
            gh pr merge "$BRANCH" --squash --delete-branch --admin
          else
            echo "‚úÖ Formula and README are already up to date."
          fi
